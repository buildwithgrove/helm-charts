# HTTPRoute Generator for Services
#
# Generates an HTTPRoute resource for each service in the `services` list, configuring routing
# based on subdomain patterns (service ID or aliases).
#
# Ref: https://gateway.envoyproxy.io/latest/api/gateway_api/httproute/
#
# Routing behavior:
#   - The `hostnames` field specifies which subdomains will match the request
#   - All matched requests receive a "target-service-id: [SERVICE_ID]" header
#
# Example configuration:
# services:
#   - serviceId: F00C
#     aliases:
#       - eth
#       - eth-mainnet
#
# This configuration would match requests to:
#   - https://<ALIAS OR SERVICE_ID>.path.grove.city/v1
# For example:
#   - https://F00C.path.grove.city/v1
#   - https://eth.path.grove.city/v1
#   - https://eth-mainnet.path.grove.city/v1
#
# All these requests would receive the header "target-service-id: F00C"
{{- $gwname:= default "guard" $.Values.fullnameOverride }}
{{- $name:= include "guard-helm.fullname" . }}

{{- range .Values.services }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute

metadata:
  # eg. F00C-subdomain-route
  name: {{ .serviceId | lower }}-subdomain-route

spec:
  parentRefs:
  - kind: Gateway
    name: {{$gwname}}-envoy-gateway

  # Match requests based on their subdomain.
  hostnames:
  - "{{ .serviceId | lower }}.{{ $.Values.domain }}"
  {{- if .aliases }}
  {{- range .aliases }}
  - "{{ . | lower }}.{{ $.Values.domain }}"
  {{- end }}
  {{- end }}

  rules:
  # Determine the backend service to route to.
  - backendRefs:
    - name: {{ $.Values.global.serviceName }}
      port: {{ $.Values.global.port }}

    filters:
    # Ensure the request header "target-service-id" is set to the authoritative service ID.
    - type: RequestHeaderModifier
      requestHeaderModifier:
        set:
        - name: "target-service-id"
          value: "{{ .serviceId }}"

    matches:
    # Match any path prefix that starts with "/v1"
    - path:
        type: PathPrefix
        value: /v1

{{- end }}
